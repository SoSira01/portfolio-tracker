<!DOCTYPE html>
<html lang="en" data-theme="corporate">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asset Portfolio Tracker</title>
    <!-- DaisyUI and Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.7.7/dist/full.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {}
            },
            daisyui: {
                themes: ["light", "dark", "corporate", "business", "garden"]
            }
        }
    </script>
    <style>
        .positive {
            color: hsl(var(--su));
        }
        
        .negative {
            color: hsl(var(--er));
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* Add to your existing styles */
        .fade-out {
            opacity: 0;
            transition: opacity 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .alert {
            animation: fadeIn 0.3s ease-in;
        }
        
        /* Search highlighting */
        .highlight {
            background-color: rgba(var(--p), 0.2);
        }
        
        /* Fix for toast notifications */
        .alert {
            z-index: 1000;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Fix for hamburger menu in fullscreen */
        .drawer-side {
            z-index: 999;
        }
        
        .drawer-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .drawer-side .menu {
            background-color: hsl(var(--b1));
        }
        
        /* Improve stat display on mobile */
        @media (max-width: 768px) {
            .stat-value {
                font-size: 1.25rem;
                word-break: break-word;
                overflow-wrap: break-word;
                line-height: 1.3;
            }
            
            .stat {
                min-height: 80px; /* Ensure consistent stat box height */
            }
        }
        
        /* Ensure the hamburger icon stands out */
        .navbar-start label.btn {
            position: relative;
            z-index: 100;
            cursor: pointer;
        }
        
        /* Ensure the hamburger icon stands out */
        .navbar-start label.btn svg {
            stroke: currentColor;
        }
        
        /* Make sure the menu items are clickable */
        .drawer-side .menu a {
            cursor: pointer;
        }
    </style>
    <!-- Add this in the head section, just before your existing scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Add this to your head section, just after the other style tags -->
    <style>
        /* Mobile-specific styles */
        @media (max-width: 768px) {
            /* Make tables scrollable horizontally on mobile */
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Adjust font sizes for mobile */
            .stat-value {
                font-size: 1.5rem;
            }
            
            /* Make search input larger on mobile for touch targets */
            #stock-search {
                height: 2.5rem;
            }
            
            /* Improve spacing for mobile forms */
            .form-control {
                margin-bottom: 0.75rem;
            }
            
            /* Hide less important columns on small screens */
            @media (max-width: 640px) {
                .table th:nth-child(4),
                .table th:nth-child(5),
                .table td:nth-child(4),
                .table td:nth-child(5) {
                    display: none;
                }
            }
            
            /* Make the stock search more usable on small screens */
            .input-group {
                width: 100%;
            }
            
            /* Remove extra spacing */
            .container {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            /* Improve modal usability on mobile */
            .modal-box {
                margin: 0.5rem;
                max-width: calc(100% - 1rem);
                width: calc(100% - 1rem);
            }
        }
        
        /* Improve table responsiveness across all screen sizes */
        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
        }
        
        /* Toast notifications position for mobile */
        .alert.fixed {
            max-width: 90%;
            left: 5%;
            right: 5%;
        }

        /* Add these mobile enhancements to your existing styles */
        @media (max-width: 640px) {
            /* Better table display on mobile */
            table.mobile-optimized {
                border: 0;
            }
            
            table.mobile-optimized thead {
                border: none;
                clip: rect(0 0 0 0);
                height: 1px;
                margin: -1px;
                overflow: hidden;
                padding: 0;
                position: absolute;
                width: 1px;
            }
            
            table.mobile-optimized tr {
                border-bottom: 3px solid hsl(var(--b3));
                display: block;
                margin-bottom: .625em;
            }
            
            table.mobile-optimized td {
                border-bottom: 1px solid hsl(var(--b3));
                display: block;
                font-size: .8em;
                text-align: right;
                padding: 0.5rem;
            }
            
            table.mobile-optimized td::before {
                content: attr(data-label);
                float: left;
                font-weight: bold;
                text-transform: uppercase;
                opacity: 0.7;
            }
            
            table.mobile-optimized td:last-child {
                border-bottom: 0;
            }
            
            /* Better button spacing on mobile */
            .btn-xs {
                padding: 0.5rem;
                margin: 0.1rem;
            }
            
            /* Improve form layouts on mobile */
            .form-control {
                margin-bottom: 1rem;
            }
            
            /* Make modals better on mobile */
            .modal-box {
                margin: 1rem;
                padding: 1rem;
                width: calc(100% - 2rem);
                max-width: none;
            }
            
            /* Fix scroll issues with modals */
            .modal-box.has-keyboard {
                padding-bottom: 40vh;
            }
            
            /* Improve chart layout on mobile */
            canvas {
                max-height: 250px !important;
            }
            
            /* Performance cards layout */
            .card-body {
                padding: 1rem;
            }
            
            /* Stack action buttons */
            td .flex.gap-2 {
                flex-direction: column;
            }
        }
        
        /* Improve tap targets throughout the app */
        @media (max-width: 768px) {
            .btn, button, .tab, .navbar a, .drawer-side a {
                min-height: 2.5rem;
            }
            
            /* Make sure the bottom stats are visible without scrolling too much */
            .stat {
                padding: 0.75rem;
            }
            
            /* More visible active tabs */
            [role="tab"].tab-active {
                border-bottom-width: 3px;
            }
            
            /* Touch-friendly dropdowns */
            #symbol-autocomplete {
                max-height: 50vh;
            }
            
            #symbol-autocomplete .stock-result-item {
                padding: 0.75rem 1rem;
            }
            
            /* Better toast positioning for mobile */
            .alert.fixed {
                width: 90%;
                left: 5%;
                right: 5%;
                bottom: 1rem;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="drawer">
    <input id="my-drawer" type="checkbox" class="drawer-toggle" />
    <div class="drawer-content">
        <!-- Navbar -->
        <div class="navbar bg-base-100 shadow-lg mb-4">
            <div class="navbar-start">
                <label for="my-drawer" class="btn btn-ghost drawer-button">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-5 h-5 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </label>
                <h1 class="text-xl font-bold">Asset Portfolio Tracker</h1>
            </div>
            <div class="navbar-end">
                <button class="btn btn-ghost tooltip tooltip-bottom" data-tip="Refresh Stock Prices" id="refresh-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
                <button class="btn btn-ghost" onclick="document.getElementById('theme-modal').showModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                    </svg>
                </button>
            </div>
        </div>

        <div class="container mx-auto px-4 py-2">
            <!-- Your existing content starts here -->
                <div class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-2 md:gap-4 mb-4 md:mb-6">
                    <div class="stat bg-base-100 shadow rounded-box">
                        <div class="stat-title">Portfolio Value</div>
                        <div class="stat-value text-primary" id="total-value">$0.00</div>
                    </div>
                    <div class="stat bg-base-100 shadow rounded-box">
                        <div class="stat-title">Total Gain/Loss</div>
                        <div class="stat-value" id="total-gain-loss">$0.00 (0%)</div>
                    </div>
                    <div class="stat bg-base-100 shadow rounded-box">
                        <div class="stat-title">Today's Change</div>
                        <div class="stat-value" id="today-change">$0.00 (0%)</div>
                    </div>
                    <div class="stat bg-base-100 shadow rounded-box">
                        <div class="stat-title">Total Assets</div>
                        <div class="stat-value text-secondary" id="total-assets">0</div>
                    </div>
                </div>

                <!-- Make tabs scroll horizontally on mobile -->
                <div class="overflow-x-auto pb-2 mb-2">
                    <div role="tablist" class="tabs tabs-lifted">
                        <a role="tab" class="tab tab-active" data-tab="stocks">Stocks</a>
                        <a role="tab" class="tab" data-tab="bonds">Bonds</a>
                        <a role="tab" class="tab" data-tab="gold">Gold</a>
                        <a role="tab" class="tab" data-tab="cash">Cash & Others</a>
                        <a role="tab" class="tab" data-tab="overview">Portfolio Overview</a>
                    </div>
                </div>

                <!-- Stock Tab Content -->
                <div class="tab-content active" id="stocks-tab">
                    <!-- Replace the stock list header section with this responsive version -->
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                        <h2 class="text-xl sm:text-2xl font-bold">Stock Holdings</h2>
                        <div class="w-full sm:w-auto flex flex-col sm:flex-row items-start sm:items-center gap-2">
                            <div class="form-control w-full sm:w-auto">
                                <div class="input-group">
                                    <input type="text" id="stock-search" placeholder="Search stocks..." class="input input-bordered w-full" />
                                    <button class="btn btn-square" id="clear-search-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <button class="btn btn-primary w-full sm:w-auto" id="add-stock-btn">Add Stock</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto table-responsive">
                        <table class="table table-zebra w-full">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Name</th>
                                    <th>Shares</th>
                                    <th>Avg. Price</th>
                                    <th>Current Price</th>
                                    <th>Market Value</th>
                                    <th>Gain/Loss</th>
                                    <th>% Change</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="stock-list">
                                <!-- Stock data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Bond Tab Content -->
                <div class="tab-content" id="bonds-tab">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Bond Holdings</h2>
                        <button class="btn btn-primary" id="add-bond-btn">Add Bond</button>
                    </div>
                    <div class="overflow-x-auto table-responsive">
                        <table class="table table-zebra w-full">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Face Value</th>
                                    <th>Purchase Price</th>
                                    <th>Yield</th>
                                    <th>Maturity Date</th>
                                    <th>Current Value</th>
                                    <th>Gain/Loss</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bond-list">
                                <!-- Bond data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Gold Tab Content -->
                <div class="tab-content" id="gold-tab">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
                        <h2 class="text-xl sm:text-2xl font-bold">Gold Holdings</h2>
                        <button class="btn btn-primary w-full sm:w-auto" id="add-gold-btn">Add Gold</button>
                    </div>
                    <div class="overflow-x-auto table-responsive">
                        <table class="table table-zebra w-full">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Weight (oz)</th>
                                    <th>Purchase Price</th>
                                    <th>Purchase Date</th>
                                    <th>Current Price</th>
                                    <th>Market Value</th>
                                    <th>Gain/Loss</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="gold-list">
                                <!-- Gold data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Cash Tab Content -->
                <div class="tab-content" id="cash-tab">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold">Cash & Other Assets</h2>
                        <button class="btn btn-primary" id="add-cash-btn">Add Asset</button>
                    </div>
                    <div class="overflow-x-auto table-responsive">
                        <table class="table table-zebra w-full">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Value</th>
                                    <th>Currency</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="cash-list">
                                <!-- Cash data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Overview Tab Content -->
                <div class="tab-content" id="overview-tab">
                    <div class="card bg-base-100 shadow-xl mb-6">
                        <div class="card-body">
                            <h3 class="card-title">Asset Allocation</h3>
                            <div style="position: relative; height: 300px; width: 100%;">
                                <canvas id="allocation-chart" style="max-height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="card bg-base-100 shadow-xl">
                            <div class="card-body">
                                <h3 class="card-title">Top Performers</h3>
                                <ul id="top-performers" class="mt-4">
                                    <!-- Top performers will be populated here -->
                                </ul>
                            </div>
                        </div>

                        <div class="card bg-base-100 shadow-xl">
                            <div class="card-body">
                                <h3 class="card-title">Worst Performers</h3>
                                <ul id="worst-performers" class="mt-4">
                                    <!-- Worst performers will be populated here -->
                                </ul>
                            </div>
                        </div>

                        <div class="card bg-base-100 shadow-xl">
                            <div class="card-body">
                                <h3 class="card-title">Asset Summary</h3>
                                <div class="overflow-x-auto mt-4">
                                    <table class="table table-xs">
                                        <thead>
                                            <tr>
                                                <th>Asset Type</th>
                                                <th>Count</th>
                                                <th>Total Value</th>
                                                <th>Allocation</th>
                                            </tr>
                                        </thead>
                                        <tbody id="asset-summary">
                                            <!-- Asset summary will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Add this in the grid below your Asset Summary card in the overview tab -->
                        <div class="card bg-base-100 shadow-xl">
                            <div class="card-body" id="exchange-rates-container">
                                <!-- This will be filled by updateExchangeRatesTable() -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar drawer -->
        <div class="drawer-side">
            <label for="my-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
            <ul class="menu p-4 w-80 min-h-full bg-base-200 text-base-content">
                <li class="menu-title">Navigation</li>
                <li><a data-tab="stocks" class="active">Stocks</a></li>
                <li><a data-tab="bonds">Bonds</a></li>
                <li><a data-tab="gold">Gold</a></li>
                <li><a data-tab="cash">Cash & Others</a></li>
                <li><a data-tab="overview">Portfolio Overview</a></li>
                <li class="menu-title mt-4">Settings</li>
                <li><a onclick="document.getElementById('theme-modal').showModal()">Theme Settings</a></li>
                <li><a id="export-data-btn">Export Data</a></li>
                <li><a onclick="document.getElementById('about-modal').showModal()">About</a></li>
            </ul>
        </div>
    </div>

    <!-- Add Stock Modal -->
    <dialog id="add-stock-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Add Stock</h3>
            <form id="add-stock-form" class="py-4">
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Symbol</span>
                    </label>
                    <input type="text" id="stock-symbol" placeholder="Type to search (e.g. MSFT, AAPL)" class="input input-bordered w-full" required />
                    <!-- Autocomplete dropdown will appear here -->
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Name</span>
                        <span class="label-text-alt">(Auto-populated)</span>
                    </label>
                    <input type="text" id="stock-name" placeholder="e.g. Microsoft Corporation" class="input input-bordered w-full" />
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Number of Shares</span>
                    </label>
                    <input type="number" id="stock-shares" placeholder="e.g. 10" step="0.01" class="input input-bordered w-full" required />
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Purchase Price Per Share</span>
                    </label>
                    <input type="number" id="stock-price" placeholder="e.g. 325.50" step="0.01" class="input input-bordered w-full" required />
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Purchase Date</span>
                    </label>
                    <input type="date" id="stock-date" class="input input-bordered w-full" required />
                </div>
                <div class="modal-action">
                    <button type="button" class="btn btn-outline close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Stock</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Add Bond Modal -->
    <dialog id="add-bond-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Add Bond</h3>
            <form id="add-bond-form" class="py-4">
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Bond Name</span>
                    </label>
                    <input type="text" id="bond-name" placeholder="e.g. US Treasury" class="input input-bordered w-full" required />
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Type</span>
                    </label>
                    <select id="bond-type" class="select select-bordered w-full" required>
                        <option value="government">Government</option>
                        <option value="municipal">Municipal</option>
                        <option value="corporate">Corporate</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Face Value</span>
                    </label>
                    <input type="number" id="bond-face-value" placeholder="e.g. 1000" step="0.01" class="input input-bordered w-full" required />
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Purchase Price</span>
                    </label>
                    <input type="number" id="bond-purchase-price" placeholder="e.g. 980" step="0.01" class="input input-bordered w-full" required />
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Yield (%)</span>
                    </label>
                    <input type="number" id="bond-yield" placeholder="e.g. 5.25" step="0.01" class="input input-bordered w-full" required />
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Maturity Date</span>
                    </label>
                    <input type="date" id="bond-maturity" class="input input-bordered w-full" required />
                </div>
                <div class="modal-action">
                    <button type="button" class="btn btn-outline close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Bond</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Add Cash/Other Modal -->
    <dialog id="add-cash-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Add Cash or Other Asset</h3>
            <form id="add-cash-form" class="py-4">
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Asset Name</span>
                    </label>
                    <input type="text" id="cash-name" placeholder="e.g. Savings Account" class="input input-bordered w-full" required />
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Type</span>
                    </label>
                    <select id="cash-type" class="select select-bordered w-full" required>
                        <option value="cash">Cash</option>
                        <option value="savings">Savings</option>
                        <option value="cd">Certificate of Deposit</option>
                        <option value="crypto">Cryptocurrency</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Value</span>
                    </label>
                    <input type="number" id="cash-value" placeholder="e.g. 5000" step="0.01" class="input input-bordered w-full" required />
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Currency</span>
                    </label>
                    <input type="text" id="cash-currency" placeholder="e.g. USD" value="USD" class="input input-bordered w-full" required />
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Notes</span>
                    </label>
                    <textarea id="cash-notes" placeholder="Optional notes" class="textarea textarea-bordered w-full"></textarea>
                </div>
                <div class="modal-action">
                    <button type="button" class="btn btn-outline close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Asset</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Theme change modal -->
    <dialog id="theme-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Choose Theme</h3>
            <div class="grid grid-cols-2 gap-4 py-4">
                <button class="btn btn-primary" onclick="setTheme('corporate')">Light (Default)</button>
                <button class="btn" onclick="setTheme('dracula')">Dark</button>
            </div>
            <div class="modal-action">
                <form method="dialog">
                    <button class="btn">Close</button>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Edit Stock Modal -->
    <dialog id="edit-stock-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">Edit Stock</h3>
            <form id="edit-stock-form" class="py-4">
                <input type="hidden" id="edit-stock-id" />
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Symbol</span>
                    </label>
                    <input type="text" id="edit-stock-symbol" placeholder="e.g. MSFT" class="input input-bordered w-full" required />
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Name</span>
                    </label>
                    <input type="text" id="edit-stock-name" placeholder="e.g. Microsoft Corporation" class="input input-bordered w-full" />
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Number of Shares</span>
                    </label>
                    <input type="number" id="edit-stock-shares" placeholder="e.g. 10" step="0.01" class="input input-bordered w-full" required />
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Purchase Price Per Share</span>
                    </label>
                    <input type="number" id="edit-stock-price" placeholder="e.g. 325.50" step="0.01" class="input input-bordered w-full" required />
                </div>
                <div class="form-control w-full">
                    <label class="label">
                        <span class="label-text">Purchase Date</span>
                    </label>
                    <input type="date" id="edit-stock-date" class="input input-bordered w-full" required />
                </div>
                <div class="modal-action">
                    <button type="button" class="btn btn-outline close-modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Add this after your other modal dialogs -->
    <dialog id="about-modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg">About Asset Portfolio Tracker</h3>
            <div class="py-4">
                <div class="flex flex-col items-center mb-4">
                    <div class="avatar">
                        <div class="w-24 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                            <img src="https://avatars.githubusercontent.com/u/47183080?s=400&u=2c5be248177bd1d2fe93352834d1977df63f002f&v=4" alt="Profile" />
                        </div>
                    </div>
                    <h2 class="text-xl font-bold mt-2">Siraphob Phairoh</h2>
                    <a href="https://github.com/SoSira01" target="_blank" class="text-primary flex items-center mt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="mr-1" viewBox="0 0 16 16">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                        </svg>
                    SoSira01
                </a>
            </div>
            <div class="divider"></div>
            <p class="mb-2">An Asset Portfolio Tracker that helps you manage and monitor your investments across different asset classes.</p>
            <p class="mb-2">Features:</p>
            <ul class="list-disc list-inside ml-4">
                <li>Track stocks, bonds, and cash assets in one place</li>
                <li>View portfolio allocation and performance</li>
                <li>Support for multiple currencies with automatic conversion</li>
                <li>Real-time price updates for stocks</li>
                <li>Responsive design for desktop and mobile</li>
            </ul>
            <p class="mt-4 text-sm opacity-75">Version 1.5 - Created 2025</p>
        </div>
        <div class="modal-action">
            <form method="dialog">
                <button class="btn">Close</button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

    <!-- Add Gold Modal -->
<dialog id="add-gold-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Add Gold</h3>
        <form id="add-gold-form" class="py-4">
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text">Name/Description</span>
                </label>
                <input type="text" id="gold-name" placeholder="e.g. Gold Coin, Gold Bar" class="input input-bordered w-full" required />
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text">Type</span>
                </label>
                <select id="gold-type" class="select select-bordered w-full" required>
                    <option value="coin">Coin</option>
                    <option value="bar">Bar</option>
                    <option value="jewelry">Jewelry</option>
                    <option value="etf">ETF</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text">Weight (oz)</span>
                </label>
                <input type="number" id="gold-weight" placeholder="e.g. 1.0" step="0.001" class="input input-bordered w-full" required />
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text">Purchase Price (per oz)</span>
                </label>
                <input type="number" id="gold-price" placeholder="e.g. 1800.00" step="0.01" class="input input-bordered w-full" required />
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text">Purchase Date</span>
                </label>
                <input type="date" id="gold-date" class="input input-bordered w-full" required />
            </div>
            <div class="modal-action">
                <button type="button" class="btn btn-outline close-modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Gold</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- Edit Gold Modal -->
<dialog id="edit-gold-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Edit Gold</h3>
        <form id="edit-gold-form" class="py-4">
            <input type="hidden" id="edit-gold-id" />
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text">Name/Description</span>
                </label>
                <input type="text" id="edit-gold-name" placeholder="e.g. Gold Coin, Gold Bar" class="input input-bordered w-full" required />
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text">Type</span>
                </label>
                <select id="edit-gold-type" class="select select-bordered w-full" required>
                    <option value="coin">Coin</option>
                    <option value="bar">Bar</option>
                    <option value="jewelry">Jewelry</option>
                    <option value="etf">ETF</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text">Weight (oz)</span>
                </label>
                <input type="number" id="edit-gold-weight" placeholder="e.g. 1.0" step="0.001" class="input input-bordered w-full" required />
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text">Purchase Price (per oz)</span>
                </label>
                <input type="number" id="edit-gold-price" placeholder="e.g. 1800.00" step="0.01" class="input input-bordered w-full" required />
            </div>
            <div class="form-control w-full">
                <label class="label">
                    <span class="label-text">Purchase Date</span>
                </label>
                <input type="date" id="edit-gold-date" class="input input-bordered w-full" required />
            </div>
            <div class="modal-action">
                <button type="button" class="btn btn-outline close-modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <script>
        // Global variables
        let stockData = JSON.parse(localStorage.getItem('stockData')) || [];
        let bondData = JSON.parse(localStorage.getItem('bondData')) || [];
        let cashData = JSON.parse(localStorage.getItem('cashData')) || [];
        let goldData = JSON.parse(localStorage.getItem('goldData')) || [];
        
        // DOM Elements
        const stockList = document.getElementById('stock-list');
        const bondList = document.getElementById('bond-list');
        const cashList = document.getElementById('cash-list');
        const goldList = document.getElementById('gold-list');
        const totalValue = document.getElementById('total-value');
        const totalGainLoss = document.getElementById('total-gain-loss');
        const todayChange = document.getElementById('today-change');
        const totalAssets = document.getElementById('total-assets');
        
        // Modal Elements
        const addStockBtn = document.getElementById('add-stock-btn');
        const addBondBtn = document.getElementById('add-bond-btn');
        const addCashBtn = document.getElementById('add-cash-btn');
        const addGoldBtn = document.getElementById('add-gold-btn');
        const addStockModal = document.getElementById('add-stock-modal');
        const addBondModal = document.getElementById('add-bond-modal');
        const addCashModal = document.getElementById('add-cash-modal');
        const addGoldModal = document.getElementById('add-gold-modal');
        const editGoldModal = document.getElementById('edit-gold-modal');
        const addStockForm = document.getElementById('add-stock-form');
        const addBondForm = document.getElementById('add-bond-form');
        const addCashForm = document.getElementById('add-cash-form');
        const addGoldForm = document.getElementById('add-gold-form');
        const editGoldForm = document.getElementById('edit-gold-form');
        
        // Tab Elements
        const tabs = document.querySelectorAll('[role="tab"]');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Theme handling
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved theme if any
            const savedTheme = localStorage.getItem('theme') || 'corporate';
            setTheme(savedTheme);
            
            // Initialize tabs
            tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            document.querySelectorAll('.drawer-side a').forEach(link => {
                if (link.dataset.tab) {
                    link.addEventListener('click', () => {
                        switchTab(link.dataset.tab);
                        document.getElementById('my-drawer').checked = false;
                    });
                }
            });
            
            // Setup modal events
            addStockBtn.addEventListener('click', () => addStockModal.showModal());
            addBondBtn.addEventListener('click', () => addBondModal.showModal());
            addCashBtn.addEventListener('click', () => addCashModal.showModal());
            addGoldBtn.addEventListener('click', () => addGoldModal.showModal());
            
            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', () => {
                    addStockModal.close();
                    addBondModal.close();
                    addCashModal.close();
                    addGoldModal.close();
                    editGoldModal.close();
                });
            });
            
            // Form submissions
            addStockForm.addEventListener('submit', handleAddStock);
            addBondForm.addEventListener('submit', handleAddBond);
            addCashForm.addEventListener('submit', handleAddCash);
            addGoldForm.addEventListener('submit', handleAddGold);
            editGoldForm.addEventListener('submit', handleEditGold);
            
            // Load data
            loadAllData();
            
            // Initial API call for stock prices
            fetchStockPrices();
            
            // Setup refresh button
            document.getElementById('refresh-btn')?.addEventListener('click', fetchStockPrices);
            
            // Create charts
            createAllocationChart();

            // Set up search functionality
            setupStockSearch();

            // Add this to your existing DOMContentLoaded event listener:
            const editStockForm = document.getElementById('edit-stock-form');
            editStockForm.addEventListener('submit', handleEditStock);

            // Set up stock search functionality
            setupStockSearch();

            // Make sure the edit modal close button works
            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', () => {
                    document.getElementById('edit-stock-modal').close();
                    document.getElementById('add-stock-modal').close();
                    document.getElementById('add-bond-modal').close();
                    document.getElementById('add-cash-modal').close();
                });
            });

            // Fetch exchange rates on load
            fetchExchangeRates();

            // Add this after other initialization code
            
            // Load saved exchange rates if available
            const savedRates = localStorage.getItem('exchangeRates');
            if (savedRates) {
                const ratesData = JSON.parse(savedRates);
                Object.assign(exchangeRates, ratesData.rates);
                
                // Check if we need to refresh rates (older than 1 day)
                const oneDayMs = 24 * 60 * 60 * 1000;
                if (Date.now() - ratesData.timestamp > oneDayMs) {
                    fetchExchangeRates();
                }
            } else {
                // No saved rates, fetch them
                fetchExchangeRates();
            }
            
            // Update the exchange rates table
            updateExchangeRatesTable();

            // Set up the About modal link
            const aboutLink = document.querySelector('.drawer-side li a:nth-child(1)');
            if (aboutLink && aboutLink.textContent.trim() === 'About') {
                aboutLink.addEventListener('click', () => {
                    document.getElementById('about-modal').showModal();
                    document.getElementById('my-drawer').checked = false;
                });
            }

            // Set up Export Data functionality
            document.getElementById('export-data-btn').addEventListener('click', function() {
                try {
                    exportPortfolioData();
                } catch (err) {
                    console.error("Export clicked error:", err);
                    showToast('Failed to export data. Check console for details.', 'error');
                }
            });

            // Add this inside the DOMContentLoaded event listener where you initialize your app
            setupStockSymbolAutocomplete();

            // Set up mobile-friendly behaviors
            setupMobileModalBehavior();
            
            // Adjust toast position on mobile
            const originalShowToast = showToast;
            showToast = function(message, type = 'info') {
                const toast = document.createElement('div');
                const isMobile = window.innerWidth < 768;
                toast.className = `alert alert-${type} fixed ${isMobile ? 'bottom-4 left-4 right-4' : 'bottom-4 right-4'} w-auto max-w-${isMobile ? 'full' : 'sm'} z-50`;
                toast.innerHTML = `<span>${message}</span>`;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('fade-out');
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 500);
                }, 3000);
            };

            // Add this inside your existing DOMContentLoaded event listener
            setupMobileModalBehavior();
            adjustTableResponsiveness();

            // Mobile stat values fix
            function adjustStatResponsiveness() {
                const statValues = document.querySelectorAll('.stat-value');
                statValues.forEach(statValue => {
                    if (window.innerWidth < 768) {
                        const content = statValue.textContent;
                        if (content.length > 12) {
                            statValue.style.fontSize = '1.25rem';
                            statValue.style.wordBreak = 'break-word';
                        } else {
                            statValue.style.fontSize = '1.5rem';
                        }
                    } else {
                        statValue.style.fontSize = '';
                        statValue.style.wordBreak = '';
                    }
                });
            }

            // Call when page loads and add to resize event
            adjustStatResponsiveness();
            window.addEventListener('resize', debounce(() => {
                adjustTableResponsiveness();
                adjustStatResponsiveness();
            }, 250));
        });
        
        // Tab functionality
        function switchTab(tabId) {
            tabs.forEach(tab => {
                if (tab.dataset.tab === tabId) {
                    tab.classList.add('tab-active');
                    tab.style.color = ''; // Remove hardcoded color and let the theme handle it
                } else {
                    tab.classList.remove('tab-active');
                    tab.style.color = ''; // Reset to default color from theme
                }
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            document.querySelectorAll('.drawer-side a').forEach(link => {
                if (link.dataset.tab) {
                    if (link.dataset.tab === tabId) {
                        link.classList.add('active');
                        link.style.color = ''; // Remove hardcoded color and let the theme handle it
                    } else {
                        link.classList.remove('active');
                        link.style.color = ''; // Reset to default color from theme
                    }
                }
            });
            
            tabContents.forEach(content => {
                if (content.id === `${tabId}-tab`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }

        // Form handlers
        function handleAddStock(e) {
            e.preventDefault();
            
            const symbol = document.getElementById('stock-symbol').value.toUpperCase();
            const shares = parseFloat(document.getElementById('stock-shares').value);
            const price = parseFloat(document.getElementById('stock-price').value);
            const date = document.getElementById('stock-date').value;
            
            // Show loading state
            const submitButton = addStockForm.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="loading loading-spinner loading-xs"></span> Verifying...';
            
            // First verify the stock exists by fetching its current data
            fetchStockDetails(symbol)
                .then(data => {
                    if (data && (data.name || data.price)) {
                        // Stock exists in the market, create the new stock object
                        const newStock = {
                            id: Date.now().toString(),
                            symbol,
                            shares,
                            purchasePrice: price,
                            purchaseDate: date,
                            currentPrice: data.price || price,
                            name: data.name || symbol,
                            change: 0,
                            changePercent: 0
                        };
                        
                        // Add to portfolio
                        stockData.push(newStock);
                        saveStockData();
                        renderStockList();
                        updateSummary();
                        addStockModal.close();
                        addStockForm.reset();
                        
                        showToast(`${symbol} added successfully!`, 'success');
                        
                        // Also fetch the current price
                        fetchCurrentStockPrice(symbol);
                        
                    } else {
                        // Stock validation failed
                        showToast(`Could not verify stock symbol '${symbol}'. Please check the symbol and try again.`, 'error');
                    }
                })
                .catch(error => {
                    console.error("Error verifying stock:", error);
                    showToast(`Error verifying stock symbol '${symbol}'.`, 'error');
                })
                .finally(() => {
                    // Restore button
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                });
        }

        function handleAddBond(e) {
            e.preventDefault();
            
            const name = document.getElementById('bond-name').value;
            const type = document.getElementById('bond-type').value;
            const faceValue = parseFloat(document.getElementById('bond-face-value').value);
            const purchasePrice = parseFloat(document.getElementById('bond-purchase-price').value);
            const yieldRate = parseFloat(document.getElementById('bond-yield').value);
            const maturityDate = document.getElementById('bond-maturity').value;
            
            const newBond = {
                id: Date.now().toString(),
                name,
                type,
                faceValue,
                purchasePrice,
                yieldRate,
                maturityDate,
                currentValue: purchasePrice
            };
            
            bondData.push(newBond);
            saveBondData();
            renderBondList();
            updateSummary();
            addBondModal.close();
            addBondForm.reset();
        }
        
        function handleAddCash(e) {
            e.preventDefault();
            
            const name = document.getElementById('cash-name').value;
            const type = document.getElementById('cash-type').value;
            const value = parseFloat(document.getElementById('cash-value').value);
            const currency = document.getElementById('cash-currency').value;
            const notes = document.getElementById('cash-notes').value;
            
            const newCash = {
                id: Date.now().toString(),
                name,
                type,
                value,
                currency,
                notes
            };
            
            cashData.push(newCash);
            saveCashData();
            renderCashList();
            updateSummary();
            addCashModal.close();
            addCashForm.reset();
        }
        
        // Data handling
        function saveStockData() {
            localStorage.setItem('stockData', JSON.stringify(stockData));
        }
        
        function saveBondData() {
            localStorage.setItem('bondData', JSON.stringify(bondData));
        }
        
        function saveCashData() {
            localStorage.setItem('cashData', JSON.stringify(cashData));
        }

        function saveGoldData() {
            localStorage.setItem('goldData', JSON.stringify(goldData));
        }
        
        function loadAllData() {
            renderStockList();
            renderBondList();
            renderGoldList(); 
            renderCashList();
            updateSummary();
        }
        
        // Rendering functions
        // Update the renderStockList function to include edit button and search filtering
        function renderStockList() {
            // Get search term
            const searchTerm = (document.getElementById('stock-search')?.value || '').toLowerCase();
            
            // Filter stocks by search term if it exists
            const filteredStocks = searchTerm 
                ? stockData.filter(stock => 
                    stock.symbol.toLowerCase().includes(searchTerm) || 
                    (stock.name && stock.name.toLowerCase().includes(searchTerm)))
                : stockData;
            
            stockList.innerHTML = '';
            
            if (filteredStocks.length === 0) {
                if (searchTerm && stockData.length > 0) {
                    stockList.innerHTML = '<tr><td colspan="9" class="text-center">No stocks match your search. Try a different term.</td></tr>';
                } else {
                    stockList.innerHTML = '<tr><td colspan="9" class="text-center">No stocks added yet. Click "Add Stock" to get started.</td></tr>';
                }
                return;
            }
            
            filteredStocks.forEach(stock => {
                const marketValue = stock.shares * stock.currentPrice;
                const costBasis = stock.shares * stock.purchasePrice;
                const gainLoss = marketValue - costBasis;
                const gainLossPercent = (gainLoss / costBasis) * 100;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${stock.symbol}</td>
                    <td>${stock.name || stock.symbol}</td>
                    <td>${formatCurrency(stock.shares)}</td>
                    <td>$${formatCurrency(stock.purchasePrice)}</td>
                    <td>$${formatCurrency(stock.currentPrice)}</td>
                    <td>$${formatCurrency(marketValue)}</td>
                    <td class="${gainLoss >= 0 ? 'positive' : 'negative'}">$${formatCurrency(gainLoss)}</td>
                    <td class="${gainLossPercent >= 0 ? 'positive' : 'negative'}">${gainLossPercent.toFixed(2)}%</td>
                    <td>
                        <div class="flex gap-2 justify-end">
                            <button class="btn btn-ghost btn-xs" onclick="editStock('${stock.id}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 0L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button class="btn btn-error btn-xs" onclick="deleteStock('${stock.id}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </td>
                `;
                stockList.appendChild(row);
            });
        }
        
        function renderBondList() {
            bondList.innerHTML = '';
            
            if (bondData.length === 0) {
                bondList.innerHTML = '<tr><td colspan="9" class="text-center">No bonds added yet. Click "Add Bond" to get started.</td></tr>';
                return;
            }
            
            bondData.forEach(bond => {
                // Calculate current bond value (simplified)
                // In a real app, you would calculate this based on yield curves and time to maturity
                const maturityDate = new Date(bond.maturityDate);
                const today = new Date();
                const timeToMaturity = (maturityDate - today) / (1000 * 60 * 60 * 24 * 365); // in years
                
                // Simple approximation - in reality bond pricing is more complex
                let currentValue;
                if (timeToMaturity <= 0) {
                    currentValue = bond.faceValue;
                } else {
                    // Simplified calculation
                    const marketYield = bond.yieldRate * 0.95; // Assume current yields are 5% lower than when purchased
                    currentValue = bond.faceValue / Math.pow(1 + marketYield/100, timeToMaturity);
                }
                
                const gainLoss = currentValue - bond.purchasePrice;
                const gainLossPercent = (gainLoss / bond.purchasePrice) * 100;
                
                bond.currentValue = currentValue; // Update the bond's current value
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${bond.name}</td>
                    <td><div class="badge badge-outline">${capitalizeFirstLetter(bond.type)}</div></td>
                    <td>$${bond.faceValue.toFixed(2)}</td>
                    <td>$${bond.purchasePrice.toFixed(2)}</td>
                    <td>${bond.yieldRate.toFixed(2)}%</td>
                    <td>${formatDate(bond.maturityDate)}</td>
                    <td>$${currentValue.toFixed(2)}</td>
                    <td class="${gainLoss >= 0 ? 'positive' : 'negative'}">$${gainLoss.toFixed(2)} (${gainLossPercent.toFixed(2)}%)</td>
                    <td>
                        <button class="btn btn-error btn-sm" onclick="deleteBond('${bond.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </td>
                `;
                bondList.appendChild(row);
            });
        }
        
        function renderCashList() {
            cashList.innerHTML = '';
            
            if (cashData.length === 0) {
                cashList.innerHTML = '<tr><td colspan="6" class="text-center">No cash assets added yet. Click "Add Asset" to get started.</td></tr>';
                return;
            }
            
            cashData.forEach(cash => {
                // Calculate USD equivalent
                const valueInUSD = convertToUSD(cash.value, cash.currency);
                
                // For USD, also show THB equivalent (if THB rate exists)
                let thbEquivalent = '';
                if (cash.currency === 'USD' && exchangeRates['THB']) {
                    const valueInTHB = cash.value * (1 / exchangeRates['THB']);
                    thbEquivalent = `<div class="text-xs opacity-70">≈ ฿${formatCurrency(valueInTHB)} THB</div>`;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${cash.name}</td>
                    <td><div class="badge badge-ghost">${capitalizeFirstLetter(cash.type)}</div></td>
                    <td>${cash.currency} ${formatCurrency(cash.value)}
                        ${cash.currency !== 'USD' ? `<div class="text-xs opacity-70">≈ $${formatCurrency(valueInUSD)} USD</div>` : thbEquivalent}
                    </td>
                    <td>${cash.currency}</td>
                    <td>${cash.notes || '-'}</td>
                    <td>
                        <div class="flex gap-2 justify-end">
                            <button class="btn btn-ghost btn-xs" onclick="editCash('${cash.id}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 0L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button class="btn btn-error btn-xs" onclick="deleteCash('${cash.id}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </td>
                `;
                cashList.appendChild(row);
            });
        }

        function renderGoldList() {
            goldList.innerHTML = '';
            
            if (goldData.length === 0) {
                goldList.innerHTML = '<tr><td colspan="9" class="text-center">No gold assets added yet. Click "Add Gold" to get started.</td></tr>';
                return;
            }
            
            // Get the current gold price (could be fetched from an API)
            // For demo, we'll calculate an average change from purchase prices
            const avgPriceChange = 0.05; // 5% average change
            
            goldData.forEach(gold => {
                // Calculate current price (in a real app, fetch from API)
                // For demo, we'll use the purchase price +/- a random fluctuation
                let currentPrice;
                if (!gold.currentPrice) {
                    const randomChange = Math.random() * avgPriceChange * 2 - avgPriceChange; // -5% to +5%
                    currentPrice = gold.purchasePrice * (1 + randomChange);
                    gold.currentPrice = currentPrice;
                } else {
                    currentPrice = gold.currentPrice;
                }
                
                const marketValue = gold.weight * currentPrice;
                const costBasis = gold.weight * gold.purchasePrice;
                const gainLoss = marketValue - costBasis;
                const gainLossPercent = (gainLoss / costBasis) * 100;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${gold.name}</td>
                    <td><div class="badge badge-outline">${capitalizeFirstLetter(gold.type)}</div></td>
                    <td>${formatCurrency(gold.weight)}</td>
                    <td>$${formatCurrency(gold.purchasePrice)}</td>
                    <td>${formatDate(gold.purchaseDate)}</td>
                    <td>$${formatCurrency(currentPrice)}</td>
                    <td>$${formatCurrency(marketValue)}</td>
                    <td class="${gainLoss >= 0 ? 'positive' : 'negative'}">$${formatCurrency(gainLoss)} (${gainLossPercent.toFixed(2)}%)</td>
                    <td>
                        <div class="flex gap-2 justify-end">
                            <button class="btn btn-ghost btn-xs" onclick="editGold('${gold.id}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 0L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button class="btn btn-error btn-xs" onclick="deleteGold('${gold.id}')">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </td>
                `;
                goldList.appendChild(row);
            });
        }
        
        // Helper functions - reusing from your original code
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
        
        // These functions would need to be implemented to make the app fully functional
        // Update the updateSummary function to use the new formatting helper
        function updateSummary() {
            // Calculate total portfolio value
            let totalStockValue = stockData.reduce((sum, stock) => {
                return sum + (stock.shares * stock.currentPrice);
            }, 0);
            
            let totalBondValue = bondData.reduce((sum, bond) => {
                return sum + bond.currentValue;
            }, 0);
            
            let totalGoldValue = goldData.reduce((sum, gold) => {
                return sum + (gold.weight * gold.currentPrice);
            }, 0);
            
            let totalCashValue = cashData.reduce((sum, cash) => {
                // Convert all currencies to USD
                const valueInUSD = convertToUSD(cash.value, cash.currency);
                return sum + valueInUSD;
            }, 0);
            
            // Calculate total portfolio value
            const portfolioValue = totalStockValue + totalBondValue + totalGoldValue + totalCashValue;
            
            // Calculate total investment/cost basis
            const totalStockCost = stockData.reduce((sum, stock) => {
                return sum + (stock.shares * stock.purchasePrice);
            }, 0);
            
            const totalBondCost = bondData.reduce((sum, bond) => {
                return sum + bond.purchasePrice;
            }, 0);

            const totalGoldCost = goldData.reduce((sum, gold) => {
                return sum + (gold.weight * gold.purchasePrice);
            }, 0);
            
            // Total cost basis (cash is always at cost)
            const totalCost = totalStockCost + totalBondCost + totalGoldCost + totalCashValue;
            
            // Calculate total gain/loss
            const totalGainLossValue = portfolioValue - totalCost;
            const totalGainLossPercent = totalCost > 0 ? (totalGainLossValue / totalCost) * 100 : 0;
            
            // Calculate today's change
            const todayChangeValue = stockData.reduce((sum, stock) => {
                return sum + (stock.shares * stock.change);
            }, 0);
            
            const todayChangePercent = portfolioValue > 0 ? (todayChangeValue / portfolioValue) * 100 : 0;
            
            // Update the DOM with formatted numbers
            // Add THB equivalent to the portfolio value display
            let thbDisplay = '';
            if (exchangeRates['THB']) {
                const valueInTHB = portfolioValue * (1 / exchangeRates['THB']);
                thbDisplay = `<div class="text-xs opacity-70">≈ ฿${formatCurrency(valueInTHB)} THB</div>`;
            }
            
            totalValue.innerHTML = `$${formatCurrency(portfolioValue)}${thbDisplay}`;
            totalGainLoss.textContent = `$${formatCurrency(totalGainLossValue)} (${totalGainLossPercent.toFixed(2)}%)`;
            totalGainLoss.className = totalGainLossValue >= 0 ? 'stat-value text-success' : 'stat-value text-error';
            
            todayChange.textContent = `$${formatCurrency(todayChangeValue)} (${todayChangePercent.toFixed(2)}%)`;
            todayChange.className = todayChangeValue >= 0 ? 'stat-value text-success' : 'stat-value text-error';
            
            totalAssets.textContent = stockData.length + bondData.length + goldData.length + cashData.length;
            
            // Update allocation chart
            createAllocationChart();
            
            // Update top/worst performers lists
            updatePerformersLists();
        }

        function updatePerformersLists() {
            // Combine all assets for performance tracking
            const allAssets = [
                ...stockData.map(stock => {
                    const gainLoss = stock.currentPrice - stock.purchasePrice;
                    const gainLossPercent = (gainLoss / stock.purchasePrice) * 100;
                    return {
                        id: stock.id,
                        name: stock.name || stock.symbol,
                        type: 'stock',
                        gainLossPercent: gainLossPercent,
                        value: stock.shares * stock.currentPrice
                    };
                }),
                ...bondData.map(bond => {
                    const gainLoss = bond.currentValue - bond.purchasePrice;
                    const gainLossPercent = (gainLoss / bond.purchasePrice) * 100;
                    return {
                        id: bond.id,
                        name: bond.name,
                        type: 'bond',
                        gainLossPercent: gainLossPercent,
                        value: bond.currentValue
                    };
                }),
                ...goldData.map(gold => {
                    const gainLoss = gold.currentPrice - gold.purchasePrice;
                    const gainLossPercent = (gainLoss / gold.purchasePrice) * 100;
                    return {
                        id: gold.id,
                        name: gold.name,
                        type: 'gold',
                        gainLossPercent: gainLossPercent,
                        value: gold.weight * gold.currentPrice
                    };
                })
            ];
            
            // Sort by performance
            allAssets.sort((a, b) => b.gainLossPercent - a.gainLossPercent);
            
            // Get top 5 performers
            const topPerformers = allAssets.slice(0, 5);
            const worstPerformers = [...allAssets].sort((a, b) => a.gainLossPercent - b.gainLossPercent).slice(0, 5);
            
            // Render top performers
            const topPerformersList = document.getElementById('top-performers');
            topPerformersList.innerHTML = '';
            topPerformers.forEach(asset => {
                const li = document.createElement('li');
                li.className = 'py-1';
                li.innerHTML = `
                    <div class="flex justify-between">
                        <span>${asset.name} (${capitalizeFirstLetter(asset.type)})</span>
                        <span class="${asset.gainLossPercent >= 0 ? 'text-success' : 'text-error'}">${asset.gainLossPercent.toFixed(2)}%</span>
                    </div>
                `;
                topPerformersList.appendChild(li);
            });
            
            // Render worst performers
            const worstPerformersList = document.getElementById('worst-performers');
            worstPerformersList.innerHTML = '';
            worstPerformers.forEach(asset => {
                const li = document.createElement('li');
                li.className = 'py-1';
                li.innerHTML = `
                    <div class="flex justify-between">
                        <span>${asset.name} (${capitalizeFirstLetter(asset.type)})</span>
                        <span class="${asset.gainLossPercent >= 0 ? 'text-success' : 'text-error'}">${asset.gainLossPercent.toFixed(2)}%</span>
                    </div>
                `;
                worstPerformersList.appendChild(li);
            });
        }
        
        // Fetches current stock prices
        function fetchStockPrices() {
            if (stockData.length === 0) return;
            
            // Show loading indicator
            document.getElementById('refresh-btn').classList.add('loading');
            
            // Get all unique symbols
            const symbols = [...new Set(stockData.map(stock => stock.symbol))];
            
            // Use Alpha Vantage API (free tier)
            const promises = symbols.map(symbol => {
                const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=DEMO`;
                return fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        try {
                            // Parse the response
                            const quoteData = data['Global Quote'];
                            if (quoteData && quoteData['05. price']) {
                                const price = parseFloat(quoteData['05. price']);
                                const change = parseFloat(quoteData['09. change']);
                                const changePercent = parseFloat(quoteData['10. change percent'].replace('%', ''));
                                
                                // Update all stocks with this symbol
                                stockData.forEach(stock => {
                                    if (stock.symbol === symbol) {
                                        stock.currentPrice = price;
                                        stock.change = change;
                                        stock.changePercent = changePercent;
                                    }
                                });
                                
                                return { symbol, success: true };
                            }
                            return { symbol, success: false, error: 'No price data found' };
                        } catch (error) {
                            return { symbol, success: false, error: error.message };
                        }
                    })
                    .catch(error => {
                        return { symbol, success: false, error: error.message };
                    });
            });
            
            // Wait for all API calls to complete
            Promise.allSettled(promises)
                .then(results => {
                    // Update localStorage with new prices
                    saveStockData();
                    
                    // Re-render the stock list with updated prices
                    renderStockList();
                    
                    // Update the summary stats
                    updateSummary();
                    
                    // Remove loading indicator
                    document.getElementById('refresh-btn').classList.remove('loading');
                    
                    // Show a toast with results
                    const successCount = results.filter(r => r.value && r.value.success).length;
                    const failCount = results.length - successCount;
                    
                    if (failCount > 0) {
                        showToast(`Updated ${successCount} stocks. ${failCount} failed.`, 'warning');
                    } else {
                        showToast(`Successfully updated ${successCount} stock prices!`, 'success');
                    }
                });
        }
        
        // Fetches detailed stock information
        function fetchStockDetails(symbol) {
            const url = `https://www.alphavantage.co/query?function=OVERVIEW&symbol=${symbol}&apikey=DEMO`;
            
            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.Name) {
                        return {
                            name: data.Name,
                            sector: data.Sector,
                            industry: data.Industry,
                            description: data.Description,
                            exists: true
                        };
                    }
                    
                    // If we couldn't get details, try getting at least the price to confirm existence
                    return fetchCurrentStockPrice(symbol)
                        .then(priceResult => {
                            if (priceResult && priceResult.success) {
                                return {
                                    name: symbol, // Default to symbol if no name found
                                    price: priceResult.price,
                                    exists: true
                                };
                            }
                            return null;
                        });
                })
                .catch(() => {
                    return null;
                });
        }
        
        // Add a toast notification system
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} fixed bottom-4 right-4 w-auto max-w-sm z-50`;
            toast.innerHTML = `<span>${message}</span>`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('fade-out');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 500);
            }, 3000);
        }
        
        // Replace the createAllocationChart function with this fixed version:

        function createAllocationChart() {
            // Calculate total values for each asset class with proper currency conversion
            const totalStockValue = stockData.reduce((sum, stock) => {
                return sum + (stock.shares * stock.currentPrice);
            }, 0);
            
            const totalBondValue = bondData.reduce((sum, bond) => {
                return sum + bond.currentValue;
            }, 0);
            
            const totalGoldValue = goldData.reduce((sum, gold) => {
                return sum + (gold.weight * gold.currentPrice);
            }, 0);
            
            // Fix the cash conversion here - use convertToUSD for each cash asset
            const totalCashValue = cashData.reduce((sum, cash) => {
                // Convert non-USD currencies to USD
                return sum + convertToUSD(cash.value, cash.currency);
            }, 0);

            // Rest of the function remains the same...
            const ctx = document.getElementById('allocation-chart');
            
            // Clear previous chart instance if it exists
            if (window.allocationChart) {
                window.allocationChart.destroy();
            }
            
            // Check if there's any data to display
            const totalValue = totalStockValue + totalBondValue + totalGoldValue + totalCashValue;
            
            if (totalValue <= 0) {
                // Display placeholder text when no data
                const container = ctx.parentElement;
                ctx.style.display = 'none';
                
                // Check if we already have a placeholder
                let placeholder = container.querySelector('.chart-placeholder');
                if (!placeholder) {
                    placeholder = document.createElement('div');
                    placeholder.className = 'chart-placeholder flex justify-center items-center h-80';
                    placeholder.innerHTML = `
                        <div class="text-center opacity-60">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                            <p>No asset data available.<br>Add stocks, bonds, or cash to see your allocation.</p>
                        </div>
                    `;
                    container.appendChild(placeholder);
                }
                return;
            }
            
            // Remove placeholder if it exists
            const placeholder = ctx.parentElement.querySelector('.chart-placeholder');
            if (placeholder) {
                placeholder.remove();
            }
            
            // Make sure canvas is visible
            ctx.style.display = 'block';
            
            // Create or update the chart
            window.allocationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Stocks', 'Bonds', 'Gold', 'Cash & Others'],
                    datasets: [{
                        data: [totalStockValue, totalBondValue, totalGoldValue, totalCashValue],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.7)',  // Blue for stocks
                            'rgba(255, 159, 64, 0.7)',  // Orange for bonds
                            'rgba(255, 215, 0, 0.7)',   // Gold color for gold
                            'rgba(75, 192, 192, 0.7)'   // Green for cash
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(255, 215, 0, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 20,
                            left: window.innerWidth < 768 ? 5 : 10,
                            right: window.innerWidth < 768 ? 5 : 10
                        }
                    },
                    plugins: {
                        legend: {
                            position: window.innerWidth < 768 ? 'bottom' : 'right',
                            labels: {
                                font: {
                                    size: window.innerWidth < 768 ? 12 : 14
                                },
                                padding: window.innerWidth < 768 ? 10 : 20,
                                boxWidth: window.innerWidth < 768 ? 12 : 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Update asset summary table
            updateAssetSummary(totalStockValue, totalBondValue, totalGoldValue, totalCashValue, totalValue);
        }

        // Add this new function to update the asset summary table
        function updateAssetSummary(stockValue, bondValue, goldValue, cashValue, totalValue) {
            const assetSummary = document.getElementById('asset-summary');
            if (!assetSummary) return;
            
            assetSummary.innerHTML = '';
            
            // Add rows for each asset type
            const rows = [
                { type: 'Stocks', count: stockData.length, value: stockValue },
                { type: 'Bonds', count: bondData.length, value: bondValue },
                { type: 'Gold', count: goldData.length, value: goldValue },
                { type: 'Cash & Others', count: cashData.length, value: cashValue },
                { type: 'Total', count: stockData.length + bondData.length + goldData.length + cashData.length, value: totalValue, isTotal: true }
            ];
            
            rows.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = row.isTotal ? 'font-bold border-t-2' : '';
                
                const percentage = totalValue > 0 ? (row.value / totalValue) * 100 : 0;
                
                tr.innerHTML = `
                    <td>${row.type}</td>
                    <td>${row.count}</td>
                    <td>$${row.value.toFixed(2)} ${row.type === 'Cash & Others' && cashData.some(c => c.currency !== 'USD') ? 
                        '<span class="text-xs opacity-70">(USD equiv.)</span>' : 
                        ''}</td>
                    <td>${row.isTotal ? '' : percentage.toFixed(2) + '%'}</td>
                `;
                
                assetSummary.appendChild(tr);
            });
        }
        
        // Delete functions
        function deleteStock(id) {
            stockData = stockData.filter(stock => stock.id !== id);
            saveStockData();
            renderStockList();
            updateSummary();
        }
        
        function deleteBond(id) {
            bondData = bondData.filter(bond => bond.id !== id);
            saveBondData();
            renderBondList();
            updateSummary();
        }
        
        function deleteCash(id) {
            cashData = cashData.filter(c => c.id !== id);
            saveCashData();
            renderCashList();
            updateSummary();
        }

        function deleteGold(id) {
            goldData = goldData.filter(gold => gold.id !== id);
            saveGoldData();
            renderGoldList();
            updateSummary();
            
            showToast('Gold asset deleted successfully', 'warning');
        }

        // Add these new functions

        // Set up search functionality
        function setupStockSearch() {
            const searchInput = document.getElementById('stock-search');
            const clearSearchBtn = document.getElementById('clear-search-btn');
            
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    renderStockList();
                });
                
                clearSearchBtn.addEventListener('click', () => {
                    searchInput.value = '';
                    renderStockList();
                });
            }
        }

        // Edit stock function
        function editStock(id) {
            const stock = stockData.find(s => s.id === id);
            if (!stock) return;
            
            // Fill the form with stock data
            document.getElementById('edit-stock-id').value = stock.id;
            document.getElementById('edit-stock-symbol').value = stock.symbol;
            document.getElementById('edit-stock-name').value = stock.name || '';
            document.getElementById('edit-stock-shares').value = stock.shares;
            document.getElementById('edit-stock-price').value = stock.purchasePrice;
            document.getElementById('edit-stock-date').value = stock.purchaseDate;
            
            // Show the modal
            document.getElementById('edit-stock-modal').showModal();
        }

        // Function to edit gold
        function editGold(id) {
            const gold = goldData.find(g => g.id === id);
            if (!gold) return;
            
            // Fill the form with gold data
            document.getElementById('edit-gold-id').value = gold.id;
            document.getElementById('edit-gold-name').value = gold.name;
            document.getElementById('edit-gold-type').value = gold.type;
            document.getElementById('edit-gold-weight').value = gold.weight;
            document.getElementById('edit-gold-price').value = gold.purchasePrice;
            document.getElementById('edit-gold-date').value = gold.purchaseDate;
            
            // Show the modal
            editGoldModal.showModal();
        }

        // Handle edit stock form submission
        function handleEditStock(e) {
            e.preventDefault();
            
            const id = document.getElementById('edit-stock-id').value;
            const symbol = document.getElementById('edit-stock-symbol').value.toUpperCase();
            const name = document.getElementById('edit-stock-name').value;
            const shares = parseFloat(document.getElementById('edit-stock-shares').value);
            const price = parseFloat(document.getElementById('edit-stock-price').value);
            const date = document.getElementById('edit-stock-date').value;
            
            // Find the stock index
            const stockIndex = stockData.findIndex(s => s.id === id);
            if (stockIndex === -1) return;
            
            // Update the stock data
            const currentStock = stockData[stockIndex];
            const oldSymbol = currentStock.symbol;
            
            // Update with new values, preserving existing values not in the form
            stockData[stockIndex] = {
                ...currentStock,
                symbol,
                name: name || symbol,
                shares,
                purchasePrice: price,
                purchaseDate: date
            };
            
            // If symbol changed, update current price too
            if (symbol !== oldSymbol) {
                fetchStockDetails(symbol)
                    .then(data => {
                        if (data) {
                            stockData[stockIndex].name = data.name || symbol;
                            // Only update current price if we get a valid price
                            if (data.price) {
                                stockData[stockIndex].currentPrice = data.price;
                            }
                            saveStockData();
                            renderStockList();
                            updateSummary();
                        }
                    });
            }
            
            // Save changes
            saveStockData();
            renderStockList();
            updateSummary();
            
            // Close modal
            document.getElementById('edit-stock-modal').close();
            showToast('Stock updated successfully', 'success');
        }

        // Function to handle editing gold
        function handleEditGold(e) {
            e.preventDefault();
            
            const id = document.getElementById('edit-gold-id').value;
            const name = document.getElementById('edit-gold-name').value;
            const type = document.getElementById('edit-gold-type').value;
            const weight = parseFloat(document.getElementById('edit-gold-weight').value);
            const price = parseFloat(document.getElementById('edit-gold-price').value);
            const date = document.getElementById('edit-gold-date').value;
            
            // Find the gold index
            const goldIndex = goldData.findIndex(g => g.id === id);
            if (goldIndex === -1) return;
            
            // Keep the current price
            const currentPrice = goldData[goldIndex].currentPrice;
            
            // Update gold data
            goldData[goldIndex] = {
                ...goldData[goldIndex],
                name,
                type,
                weight,
                purchasePrice: price,
                purchaseDate: date,
                currentPrice // Preserve current price
            };
            
            // Save changes
            saveGoldData();
            renderGoldList();
            updateSummary();
            
            // Close modal
            editGoldModal.close();
            
            showToast('Gold asset updated successfully', 'success');
        }

        // Add these constants at the top of your script section
        const exchangeRates = {
            USD: 1,
            // Other rates will be filled dynamically
        };

        // Add this function to fetch current exchange rates
        async function fetchExchangeRates() {
            try {
                // Show loading toast
                showToast('Fetching latest currency exchange rates...', 'info');
                
                // Use ExchangeRate-API's free endpoint
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                const data = await response.json();
                
                if (data && data.rates) {
                    // Update our rates with the latest data
                    Object.keys(data.rates).forEach(currency => {
                        // For our conversion function, we need 1/rate since the API gives USD to other currencies
                        exchangeRates[currency] = 1 / data.rates[currency];
                    });
                    
                    // Save rates to localStorage with timestamp
                    localStorage.setItem('exchangeRates', JSON.stringify({
                        rates: exchangeRates,
                        timestamp: Date.now()
                    }));
                    
                    showToast('Currency exchange rates updated!', 'success');
                    
                    // Update any displays that use exchange rates
                    renderCashList();
                    updateSummary();
                    updateExchangeRatesTable();
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Error fetching exchange rates:', error);
                showToast('Failed to update exchange rates. Using saved rates.', 'error');
            }
        }

        // Function to convert any currency to USD using our rates
        function convertToUSD(amount, currency) {
            if (!currency || currency === 'USD') return amount;
            
            const exchangeRate = exchangeRates[currency.toUpperCase()];
            if (!exchangeRate) {
                console.warn(`Exchange rate for ${currency} not found, using 1:1 rate`);
                return amount;
            }
            
            return amount * exchangeRate;
        }

        // Function to update the exchange rates table in the UI
        function updateExchangeRatesTable() {
            const container = document.getElementById('exchange-rates-container');
            if (!container) return;
            
            const timestamp = localStorage.getItem('exchangeRates')
                ? JSON.parse(localStorage.getItem('exchangeRates')).timestamp
                : null;
            
            const formattedDate = timestamp
                ? new Date(timestamp).toLocaleString()
                : 'Not available';
            
            let html = `
                <h3 class="card-title">Currency Exchange Rates</h3>
                <p class="text-sm mb-2">All values in the summary are converted to USD using these rates.</p>
                <p class="text-xs mb-4">Last updated: ${formattedDate}</p>
                <div class="overflow-x-auto">
                    <table class="table table-xs">
                        <thead>
                            <tr>
                                <th>Currency</th>
                                <th>1 USD equals</th>
                                <th>1 Unit to USD</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Get cash currencies used in the portfolio
            const usedCurrencies = new Set(['USD']);
            cashData.forEach(cash => {
                usedCurrencies.add(cash.currency.toUpperCase());
            });
            
            // Show all currencies used in the portfolio plus some common ones
            const commonCurrencies = ['USD', 'EUR', 'GBP', 'JPY', 'CAD', 'AUD', 'THB', 'CNY'];
            const allCurrencies = new Set([...usedCurrencies, ...commonCurrencies]);
            
            allCurrencies.forEach(currency => {
                if (!exchangeRates[currency]) return;
                
                const toUsd = exchangeRates[currency];
                const fromUsd = 1 / toUsd;
                
                html += `
                    <tr class="${usedCurrencies.has(currency) && currency !== 'USD' ? 'font-medium' : ''}">
                        <td>${currency}</td>
                        <td>${fromUsd.toFixed(4)} ${currency}</td>
                        <td>${toUsd.toFixed(4)} USD</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 flex justify-end">
                    <button class="btn btn-sm btn-ghost" onclick="fetchExchangeRates()">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Update Rates
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Add Cash edit functionality
        function editCash(id) {
            const cash = cashData.find(c => c.id === id);
            if (!cash) return;
            
            // Show edit modal
            const modal = document.createElement('dialog');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-box">
                    <h3 class="font-bold text-lg">Edit Cash Asset</h3>
                    <form id="edit-cash-form" class="py-4">
                        <input type="hidden" id="edit-cash-id" value="${cash.id}" />
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text">Asset Name</span>
                            </label>
                            <input type="text" id="edit-cash-name" value="${cash.name}" placeholder="e.g. Savings Account" class="input input-bordered w-full" required />
                        </div>
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text">Type</span>
                            </label>
                            <select id="edit-cash-type" class="select select-bordered w-full" required>
                                <option value="cash" ${cash.type === 'cash' ? 'selected' : ''}>Cash</option>
                                <option value="savings" ${cash.type === 'savings' ? 'selected' : ''}>Savings</option>
                                <option value="cd" ${cash.type === 'cd' ? 'selected' : ''}>Certificate of Deposit</option>
                                <option value="crypto" ${cash.type === 'crypto' ? 'selected' : ''}>Cryptocurrency</option>
                                <option value="other" ${cash.type === 'other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text">Value</span>
                            </label>
                            <input type="number" id="edit-cash-value" value="${cash.value}" placeholder="e.g. 5000" step="0.01" class="input input-bordered w-full" required />
                        </div>
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text">Currency</span>
                            </label>
                            <input type="text" id="edit-cash-currency" value="${cash.currency}" placeholder="e.g. USD" class="input input-bordered w-full" required />
                        </div>
                        <div class="form-control w-full">
                            <label class="label">
                                <span class="label-text">Notes</span>
                            </label>
                            <textarea id="edit-cash-notes" class="textarea textarea-bordered w-full">${cash.notes || ''}</textarea>
                        </div>
                        <div class="modal-action">
                            <button type="button" class="btn btn-outline close-edit-modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
                <form method="dialog" class="modal-backdrop">
                    <button>close</button>
                </form>
            `;
            
            document.body.appendChild(modal);
            modal.showModal();
            
            // Handle form submission
            const form = modal.querySelector('#edit-cash-form');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const id = document.getElementById('edit-cash-id').value;
                const name = document.getElementById('edit-cash-name').value;
                const type = document.getElementById('edit-cash-type').value;
                const value = parseFloat(document.getElementById('edit-cash-value').value);
                const currency = document.getElementById('edit-cash-currency').value.toUpperCase();
                const notes = document.getElementById('edit-cash-notes').value;
                
                // Find the cash index
                const cashIndex = cashData.findIndex(c => c.id === id);
                if (cashIndex === -1) return;
                
                // Update cash data
                cashData[cashIndex] = {
                    ...cashData[cashIndex],
                    name,
                    type,
                    value,
                    currency,
                    notes
                };
                
                // Save changes
                saveCashData();
                renderCashList();
                updateSummary();
                
                // Close modal
                modal.close();
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
                
                showToast('Cash asset updated successfully', 'success');
            });
            
            // Handle cancel
            modal.querySelector('.close-edit-modal').addEventListener('click', () => {
                modal.close();
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
            });
        }

        // Add this function to your script section
        function exportPortfolioData() {
            // Create a new workbook
            const wb = XLSX.utils.book_new();
            
            // Format date for filename
            const dateStr = new Date().toISOString().split('T')[0];
            
            try {
                // Create stock sheet if there's data
                if (stockData.length > 0) {
                    // Format stock data for export
                    const stockExport = stockData.map(stock => ({
                        Symbol: stock.symbol,
                        Name: stock.name || stock.symbol,
                        Shares: stock.shares,
                        'Purchase Price': stock.purchasePrice,
                        'Purchase Date': stock.purchaseDate,
                        'Current Price': stock.currentPrice,
                        'Market Value': stock.shares * stock.currentPrice,
                        'Gain/Loss': (stock.shares * stock.currentPrice) - (stock.shares * stock.purchasePrice),
                        'Gain/Loss %': (((stock.shares * stock.currentPrice) - (stock.shares * stock.purchasePrice)) / (stock.shares * stock.purchasePrice) * 100).toFixed(2) + '%'
                    }));
                    
                    // Create worksheet and add to workbook
                    const ws = XLSX.utils.json_to_sheet(stockExport);
                    XLSX.utils.book_append_sheet(wb, ws, "Stocks");
                }
                
                // Create bond sheet if there's data
                if (bondData.length > 0) {
                    // Format bond data for export
                    const bondExport = bondData.map(bond => {
                        // Calculate current value and gain/loss
                        const currentValue = bond.currentValue;
                        const gainLoss = currentValue - bond.purchasePrice;
                        const gainLossPercent = (gainLoss / bond.purchasePrice) * 100;
                        
                        return {
                            Name: bond.name,
                            Type: capitalizeFirstLetter(bond.type),
                            'Face Value': bond.faceValue,
                            'Purchase Price': bond.purchasePrice,
                            'Yield (%)': bond.yieldRate,
                            'Maturity Date': bond.maturityDate,
                            'Current Value': currentValue,
                            'Gain/Loss': gainLoss,
                            'Gain/Loss %': gainLossPercent.toFixed(2) + '%'
                        };
                    });
                    
                    // Create worksheet and add to workbook
                    const ws = XLSX.utils.json_to_sheet(bondExport);
                    XLSX.utils.book_append_sheet(wb, ws, "Bonds");
                }
                
                // Create cash sheet if there's data
                if (cashData.length > 0) {
                    // Format cash data for export
                    const cashExport = cashData.map(cash => ({
                        Name: cash.name,
                        Type: capitalizeFirstLetter(cash.type),
                        Value: cash.value,
                        Currency: cash.currency,
                        'USD Equivalent': convertToUSD(cash.value, cash.currency),
                        Notes: cash.notes || ''
                    }));
                    
                    // Create worksheet and add to workbook
                    const ws = XLSX.utils.json_to_sheet(cashExport);
                    XLSX.utils.book_append_sheet(wb, ws, "Cash");
                }

                // Create gold sheet if there's data
                if (goldData.length > 0) {
                    // Format gold data for export
                    const goldExport = goldData.map(gold => {
                        const marketValue = gold.weight * gold.currentPrice;
                        const costBasis = gold.weight * gold.purchasePrice;
                        const gainLoss = marketValue - costBasis;
                        const gainLossPercent = (gainLoss / costBasis) * 100;
                        
                        return {
                            Name: gold.name,
                            Type: capitalizeFirstLetter(gold.type),
                            'Weight (oz)': gold.weight,
                            'Purchase Price': gold.purchasePrice,
                            'Purchase Date': gold.purchaseDate,
                            'Current Price': gold.currentPrice,
                            'Market Value': marketValue,
                            'Gain/Loss': gainLoss,
                            'Gain/Loss %': gainLossPercent.toFixed(2) + '%'
                        };
                    });
                    
                    // Create worksheet and add to workbook
                    const ws = XLSX.utils.json_to_sheet(goldExport);
                    XLSX.utils.book_append_sheet(wb, ws, "Gold");
                }
                
                // Create summary sheet
                const summaryData = [];
                
                // Calculate total values
                const totalStockValue = stockData.reduce((sum, stock) => sum + (stock.shares * stock.currentPrice), 0);
                const totalBondValue = bondData.reduce((sum, bond) => sum + bond.currentValue, 0);
                const totalGoldValue = goldData.reduce((sum, gold) => sum + (gold.weight * gold.currentPrice), 0);
                const totalCashValue = cashData.reduce((sum, cash) => sum + convertToUSD(cash.value, cash.currency), 0);
                const portfolioTotal = totalStockValue + totalBondValue + totalGoldValue + totalCashValue;
                
                // Add summary rows
                summaryData.push({ Category: 'Stocks', 'Count': stockData.length, 'Value (USD)': totalStockValue, 'Allocation': ((totalStockValue / portfolioTotal) * 100).toFixed(2) + '%' });
                summaryData.push({ Category: 'Bonds', 'Count': bondData.length, 'Value (USD)': totalBondValue, 'Allocation': ((totalBondValue / portfolioTotal) * 100).toFixed(2) + '%' });
                summaryData.push({ Category: 'Gold', 'Count': goldData.length, 'Value (USD)': totalGoldValue, 'Allocation': ((totalGoldValue / portfolioTotal) * 100).toFixed(2) + '%' });
                summaryData.push({ Category: 'Cash & Others', 'Count': cashData.length, 'Value (USD)': totalCashValue, 'Allocation': ((totalCashValue / portfolioTotal) * 100).toFixed(2) + '%' });
                summaryData.push({ Category: 'Total Portfolio', 'Count': stockData.length + bondData.length + goldData.length + cashData.length, 'Value (USD)': portfolioTotal, 'Allocation': '100%' });
                
                // Create summary worksheet
                const summaryWs = XLSX.utils.json_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summaryWs, "Summary");
                
                // Generate Excel file and trigger download
                XLSX.writeFile(wb, `Portfolio_Export_${dateStr}.xlsx`);
                
                // Show confirmation
                showToast('Portfolio data exported successfully!', 'success');
                
                // Close the drawer if it's open
                document.getElementById('my-drawer').checked = false;
                
            } catch (error) {
                console.error("Export error:", error);
                showToast('Error exporting data. Please try again.', 'error');
            }
        }

        // Add this new function to specifically fetch current price
        function fetchCurrentStockPrice(symbol) {
            const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=DEMO`;
            
            return fetch(url)
                .then(response => response.json())
                .then(data => {
                    try {
                        // Parse the response
                        const quoteData = data['Global Quote'];
                        if (quoteData && quoteData['05. price']) {
                            const price = parseFloat(quoteData['05. price']);
                            const change = parseFloat(quoteData['09. change']);
                            const changePercent = parseFloat(quoteData['10. change percent'].replace('%', ''));
                            
                            // Update all stocks with this symbol
                            stockData.forEach(stock => {
                                if (stock.symbol === symbol) {
                                    stock.currentPrice = price;
                                    stock.change = change;
                                    stock.changePercent = changePercent;
                                }
                            });
                            
                            // Save and update display
                            saveStockData();
                            renderStockList();
                            updateSummary();
                            
                            return { symbol, price, success: true };
                        }
                        return { symbol, success: false, error: 'No price data found' };
                    } catch (error) {
                        return { symbol, success: false, error: error.message };
                    }
                })
                .catch(error => {
                    return { symbol, success: false, error: error.message };
                });
        }

        // Add this new function for the stock symbol autocomplete with API integration
        function setupStockSymbolAutocomplete() {
            const symbolInput = document.getElementById('stock-symbol');
            if (!symbolInput) return;
            
            // Create autocomplete container
            let autocompleteContainer = document.createElement('div');
            autocompleteContainer.className = 'bg-base-100 shadow-lg rounded-md mt-1 absolute z-50 w-full max-h-60 overflow-y-auto hidden';
            autocompleteContainer.id = 'symbol-autocomplete';
            
            // Position the container properly
            symbolInput.parentNode.style.position = 'relative';
            symbolInput.parentNode.appendChild(autocompleteContainer);
            
            // Add event listeners for input
            symbolInput.addEventListener('input', debounce(function() {
                const query = symbolInput.value.trim();
                if (query.length < 1) {
                    autocompleteContainer.classList.add('hidden');
                    return;
                }
                
                // Show loading indicator
                showLoading();
                
                // Search for stocks using API
                searchStockSymbols(query)
                    .then(results => {
                        renderSearchResults(results);
                    })
                    .catch(error => {
                        console.error('Error searching stocks:', error);
                        autocompleteContainer.innerHTML = `
                            <div class="p-3 text-sm text-error">
                                Error searching for stocks. Please try again.
                            </div>
                        `;
                        autocompleteContainer.classList.remove('hidden');
                    })
                    .finally(() => {
                        hideLoading();
                    });
            }, 500)); // Debounce to prevent too many API calls
            
            // Hide autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                if (!symbolInput.contains(e.target) && !autocompleteContainer.contains(e.target)) {
                    autocompleteContainer.classList.add('hidden');
                }
            });
            
            // Show loading indicator
            function showLoading() {
                autocompleteContainer.innerHTML = `
                    <div class="flex items-center justify-center p-4">
                        <div class="loading loading-spinner loading-sm"></div>
                        <span class="ml-2">Searching symbols...</span>
                    </div>
                `;
                autocompleteContainer.classList.remove('hidden');
            }
            
            // Hide loading indicator
            function hideLoading() {
                // Loading is replaced by results, so we don't need to do anything here
            }
            
            // Function to search stock symbols using Alpha Vantage API
            async function searchStockSymbols(query) {
                // Use Alpha Vantage's SYMBOL_SEARCH endpoint
                const url = `https://www.alphavantage.co/query?function=SYMBOL_SEARCH&keywords=${encodeURIComponent(query)}&apikey=DEMO`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data && data.bestMatches) {
                    return data.bestMatches.map(match => ({
                        symbol: match['1. symbol'],
                        name: match['2. name'],
                        type: match['3. type'],
                        region: match['4. region'],
                        currency: match['8. currency']
                    }));
                }
                
                return [];
            }
            
            // Render search results in the dropdown
            function renderSearchResults(results) {
                if (results.length === 0) {
                    autocompleteContainer.innerHTML = `
                        <div class="p-3 text-sm opacity-70">
                            No matching stocks found. Try a different search term.
                        </div>
                    `;
                    autocompleteContainer.classList.remove('hidden');
                    return;
                }
                
                // Group results by region
                const resultsByRegion = {};
                results.forEach(result => {
                    if (!resultsByRegion[result.region]) {
                        resultsByRegion[result.region] = [];
                    }
                    resultsByRegion[result.region].push(result);
                });
                
                // Build the HTML for the results
                let html = '';
                
                // First show US results as they're typically most relevant
                if (resultsByRegion['United States']) {
                    html += `<div class="text-xs font-semibold text-opacity-70 px-3 py-1 bg-base-200">United States</div>`;
                    resultsByRegion['United States'].forEach(result => {
                        html += createResultItemHTML(result);
                    });
                    delete resultsByRegion['United States']; // Remove so we don't show it twice
                }
                
                // Show other regions
                Object.keys(resultsByRegion).forEach(region => {
                    html += `<div class="text-xs font-semibold text-opacity-70 px-3 py-1 bg-base-200">${region}</div>`;
                    resultsByRegion[region].forEach(result => {
                        html += createResultItemHTML(result);
                    });
                });
                
                autocompleteContainer.innerHTML = html;
                autocompleteContainer.classList.remove('hidden');
                
                // Add click event handlers for each result
                autocompleteContainer.querySelectorAll('.stock-result-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const symbol = this.dataset.symbol;
                        const name = this.dataset.name;
                        
                        // Fill the stock symbol input
                        symbolInput.value = symbol;
                        
                        // Set the stock name if a field exists for it
                        if (document.getElementById('stock-name')) {
                            document.getElementById('stock-name').value = name;
                        }
                        
                        // Fetch current price and fill it if the field exists
                        fetchCurrentStockPrice(symbol).then(result => {
                            if (result.success && document.getElementById('stock-price')) {
                                document.getElementById('stock-price').value = result.price;
                            }
                        });
                        
                        // Hide the autocomplete dropdown
                        autocompleteContainer.classList.add('hidden');
                    });
                });
            }
            
            // Create HTML for a single search result
            function createResultItemHTML(result) {
                return `
                    <div class="px-3 py-2 hover:bg-base-200 cursor-pointer stock-result-item" 
                         data-symbol="${result.symbol}" 
                         data-name="${result.name}">
                        <div class="font-bold">${result.symbol}</div>
                        <div class="text-xs">${result.name}</div>
                        <div class="flex justify-between mt-1">
                            <span class="text-xs opacity-70">${result.type}</span>
                            <span class="text-xs opacity-70">${result.currency}</span>
                        </div>
                    </div>
                `;
            }
            
            // Debounce helper function to prevent too many API calls
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        }

        // Enhance the mobile modal behavior
        function setupMobileModalBehavior() {
            // Get all modals
            const modals = document.querySelectorAll('.modal');
            
            modals.forEach(modal => {
                // Add event listener for showing modal
                modal.addEventListener('showModal', () => {
                    document.body.classList.add('overflow-hidden');
                    
                    // Adjust modal position for better mobile viewing
                    if (window.innerWidth < 768) {
                        const modalBox = modal.querySelector('.modal-box');
                        if (modalBox) {
                            modalBox.style.maxHeight = '85vh';
                            modalBox.style.marginTop = '2rem';
                            modalBox.style.marginBottom = '2rem';
                        }
                    }
                });
                
                // Add event listener for hiding modal
                modal.addEventListener('close', () => {
                    document.body.classList.remove('overflow-hidden');
                });
            });
            
            // Make sure the mobile keyboard doesn't cause layout issues
            const inputs = document.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', () => {
                    if (window.innerWidth < 768) {
                        // Scroll to the input after a short delay to account for keyboard appearing
                        setTimeout(() => {
                            input.scrollIntoView({behavior: 'smooth', block: 'center'});
                            
                            // Add extra bottom padding to containers when keyboard is visible
                            const modalBox = input.closest('.modal-box');
                            if (modalBox) {
                                modalBox.style.paddingBottom = '40vh';
                            }
                        }, 300);
                    }
                });
                
                // Remove extra padding when input loses focus
                input.addEventListener('blur', () => {
                    if (window.innerWidth < 768) {
                        const modalBox = input.closest('.modal-box');
                        if (modalBox) {
                            modalBox.style.paddingBottom = '';
                        }
                    }
                });
            });
            
            // Adjust stock table for better mobile viewing
            adjustTableResponsiveness();
            
            // Add orientation change handling
            window.addEventListener('orientationchange', () => {
                setTimeout(adjustTableResponsiveness, 300);
            });
            
            // Make sure modals are properly centered on resize
            window.addEventListener('resize', () => {
                if (document.querySelector('.modal[open]')) {
                    const openModals = document.querySelectorAll('.modal[open]');
                    openModals.forEach(modal => {
                        const modalBox = modal.querySelector('.modal-box');
                        if (modalBox && window.innerWidth < 768) {
                            modalBox.style.maxHeight = '85vh';
                        } else if (modalBox) {
                            modalBox.style.maxHeight = '';
                        }
                    });
                }
            });
        }

        // Add this function to handle table responsiveness
        function adjustTableResponsiveness() {
            const tables = document.querySelectorAll('.table-responsive table');
            
            tables.forEach(table => {
                // For very small screens, add data-labels to cells based on headers
                if (window.innerWidth < 640) {
                    const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
                    
                    table.querySelectorAll('tbody tr').forEach(row => {
                        Array.from(row.querySelectorAll('td')).forEach((cell, index) => {
                            if (headers[index]) {
                                cell.setAttribute('data-label', headers[index]);
                            }
                        });
                    });
                    
                    table.classList.add('mobile-optimized');
                } else {
                    table.classList.remove('mobile-optimized');
                }
            });
        }

        // First, let's add a number formatting helper function

        // Add this after your other helper functions
        function formatCurrency(amount, decimals = 2) {
            return amount.toLocaleString('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        // Function to handle adding gold
        function handleAddGold(e) {
            e.preventDefault();
            
            const name = document.getElementById('gold-name').value;
            const type = document.getElementById('gold-type').value;
            const weight = parseFloat(document.getElementById('gold-weight').value);
            const price = parseFloat(document.getElementById('gold-price').value);
            const date = document.getElementById('gold-date').value;
            
            const newGold = {
                id: Date.now().toString(),
                name,
                type,
                weight,
                purchasePrice: price,
                purchaseDate: date,
                // We'll fetch the current price from an API in a real app
                currentPrice: price // Default to purchase price until updated
            };
            
            goldData.push(newGold);
            saveGoldData();
            renderGoldList();
            updateSummary();
            addGoldModal.close();
            addGoldForm.reset();
            
            showToast(`${name} added successfully!`, 'success');
            
            // In a real app, fetch the current gold price
            fetchGoldPrice();
        }

        // Function to fetch gold price (could be connected to a real API)
        async function fetchGoldPrice() {
    try {
        // Show loading state
        document.getElementById('refresh-btn').classList.add('loading');
        showToast('Fetching current gold prices...', 'info');

        // Using the goldpricez.com API (free and no API key needed)
        const response = await fetch('https://data-asg.goldprice.org/dbXRates/USD');
        
        if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data && data.items && data.items.length > 0) {
            // The API returns price in USD per troy ounce directly, no need to convert
            const goldPrice = data.items[0].xauPrice;
            
            // Update all gold items with the latest price
            goldData.forEach(gold => {
                gold.currentPrice = goldPrice;
            });
            
            // Save and update UI
            saveGoldData();
            renderGoldList();
            updateSummary();
            
            // Cache the gold price with timestamp
            localStorage.setItem('goldPriceData', JSON.stringify({
                price: goldPrice,
                timestamp: Date.now()
            }));
            
            showToast(`Gold price updated: $${formatCurrency(goldPrice)}/oz`, 'success');
        } else {
            throw new Error('Invalid data format from API');
        }
    } catch (error) {
        console.error('Error fetching gold price:', error);
        
        // Use a fallback method for demo/testing
        fallbackGoldPriceUpdate();
        
        showToast('Could not fetch gold price, using estimated price', 'warning');
    } finally {
        // Hide loading state
        document.getElementById('refresh-btn').classList.remove('loading');
    }
}

        // Fallback method to update gold prices when API fails
        function fallbackGoldPriceUpdate() {
            // Use a more realistic price based on recent market data
            const baseGoldPrice = 2350; // Close to recent price as of 2023-2024
            const randomFluctuation = (Math.random() * 40) - 20; // -$20 to +$20 fluctuation
            
            const currentGoldPrice = baseGoldPrice + randomFluctuation;
            
            // Update all gold items
            goldData.forEach(gold => {
                gold.currentPrice = currentGoldPrice;
            });
            
            // Save and update
            saveGoldData();
            renderGoldList();
            updateSummary();
            
            console.log(`Using fallback gold price: $${currentGoldPrice.toFixed(2)}/oz`);
        }

        // Add a helper function to use cached gold price when available
        function useGoldPriceCache() {
            // Check if we have a cached gold price and it's less than 1 hour old
            const cachedGoldData = localStorage.getItem('goldPriceData');
            if (cachedGoldData) {
                try {
                    const { price, timestamp } = JSON.parse(cachedGoldData);
                    const oneHourAgo = Date.now() - (60 * 60 * 1000);
                    
                    // If cache is fresh (less than 1 hour old)
                    if (timestamp > oneHourAgo) {
                        // Use the cached price for all gold items
                        goldData.forEach(gold => {
                            gold.currentPrice = price;
                        });
                        
                        // Update UI
                        renderGoldList();
                        updateSummary();
                        
                        console.log(`Using cached gold price: $${price}/oz from ${new Date(timestamp).toLocaleTimeString()}`);
                        return true;
                    }
                } catch (e) {
                    console.error('Error parsing cached gold data:', e);
                }
            }
            
            return false; // Cache miss or expired
        }

        // Update the original fetchGoldPrice function call to use the cache
        function updateGoldPrices() {
            // Try to use cached data first
            if (!useGoldPriceCache()) {
                // If no valid cache, fetch fresh data
                fetchGoldPrice();
            }
        }

        // Initialize and add event listeners for gold features
        document.addEventListener('DOMContentLoaded', function() {
            // Get gold elements
            addGoldBtn?.addEventListener('click', () => addGoldModal.showModal());
            addGoldForm?.addEventListener('submit', handleAddGold);
            editGoldForm?.addEventListener('submit', handleEditGold);
            
            // Load gold data
            renderGoldList();
            
            // Initial gold price fetch
            if (goldData.length > 0) {
                fetchGoldPrice();
            }
            
            // Make sure the refresh button updates gold prices too
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) {
                const originalRefreshClick = refreshBtn.onclick;
                refreshBtn.onclick = function() {
                    if (originalRefreshClick) originalRefreshClick();
                    if (goldData.length > 0) fetchGoldPrice();
                };
            }
        });
    </script>
</body>
</html>
